@page "/Movie/{Id:int}"
@using MoviesApp.Services.Interfaces
@using movies_api
@inject IMovieService _movieService
@using Radzen.Blazor
@using Radzen
@using System.Security.Claims
@using Microsoft.CodeAnalysis.VisualBasic.Syntax
@inject NotificationService _notificationService

@if (shouldRender == false)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
}
else
{
    <RadzenNotification/>
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center" Wrap="FlexWrap.Wrap">
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Start" Gap="1rem" Class="rz-p-4">

            <RadzenImage Path="@movie.Poster_path" Style="border-radius: 1%;"/>

            <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Start" Gap="0rem">
                <RadzenText TextStyle="TextStyle.H3" Style="color: white">
                    <strong>@movie.Title</strong>
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Style="color: white">@ToYear(movie.Release_date)</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Style="color: white">@movie.Overview</RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="0rem">
                    <RadzenText TextStyle="TextStyle.H5" Style="color: white" Class="rz-pr-4">Rating:</RadzenText>
                    <RadzenText TextStyle="TextStyle.H4" Style="color: white" Class="rz-pr-4">@movieRating.ToString("#.##")</RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="0rem">
                    <div class="rz-pr-4 rz-text-align-center">
                        <RadzenRating TValue="int" Stars="10" Value=@value Change=@(args => value = args)></RadzenRating>
                    </div>
                    <RadzenButton IsBusy="@loading" Shade="Shade.Lighter" Click=@(() => RateMovie(movie.Id)) Text="Rate" ButtonStyle="ButtonStyle.Light"/>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="0rem">
                    <RadzenText TextStyle="TextStyle.Body1" Style="color: white" Class="rz-pr-2">Number of votes:</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" Style="color: white">@numberOfVotes</RadzenText>
                </RadzenStack>
                <RadzenText TextStyle="TextStyle.H5" Style="color: white" Class="rz-pr-4">Top Cast:</RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Start" Gap="0rem">

                    <div class="card mx-4" style="width: 138px">
                        <img class="card-img-top" src="https://www.themoviedb.org/t/p/w300_and_h450_bestv2/4D0PpNI0kmP58hgrwGC3wCjxhnm.jpg" alt="Card image cap">
                        <div class="card-body">
                            <h5 class="card-title">Keanu Reeves</h5>
                            <p class="card-text">Character name</p>
                            <!--<a href="#" class="btn btn-primary">Go somewhere</a>-->
                        </div>
                    </div>

                    <div class="card mx-4" style="width: 138px">
                        <img class="card-img-top" src="https://www.themoviedb.org/t/p/w300_and_h450_bestv2/4D0PpNI0kmP58hgrwGC3wCjxhnm.jpg" alt="Card image cap">
                        <div class="card-body">
                            <h5 class="card-title">Keanu Reeves</h5>
                            <p class="card-text">Character name</p>
                            <!--<a href="#" class="btn btn-primary">Go somewhere</a>-->
                        </div>
                    </div>
                    <div class="card mx-4" style="width: 138px">
                        <img class="card-img-top" src="https://www.themoviedb.org/t/p/w300_and_h450_bestv2/4D0PpNI0kmP58hgrwGC3wCjxhnm.jpg" alt="Card image cap">
                        <div class="card-body">
                            <h5 class="card-title">Keanu Reeves</h5>
                            <p class="card-text">Character name</p>
                            <!--<a href="#" class="btn btn-primary">Go somewhere</a>-->
                        </div>
                    </div>
                </RadzenStack>

            </RadzenStack>
        </RadzenStack>
    </RadzenStack>
    <AuthorizeView>
        @{ SetUserId(context); }
        ;
    </AuthorizeView>
}

@code {

    [Parameter]
    public int Id { get; set; }

    int value;
    private MovieResponse movie;
    private RatingDto rating;
    private Boolean movieInDb = false;
    private Boolean shouldRender = false;
    private string? userId;
    private double movieRating;
    private Boolean loading = false;
    private int numberOfVotes;

    protected override async Task OnInitializedAsync()
    {
        movie = new MovieResponse();
        rating = new RatingDto();
        movie = await _movieService.GetMovieAsync(Id);
        rating = await _movieService.GetMovieRatingAsync(Id);
        if (rating.MovieId.Value == movie.Id)
        {
            movieRating = rating.RatingValue.Value;
            numberOfVotes = rating.Votes.Value;
        }
    }

    private async void CheckRatingInDb()
    {
        rating = await _movieService.GetMovieRatingAsync(Id);
        if (rating.MovieId.Value == movie.Id)
        {
            movieRating = rating.RatingValue.Value;
            numberOfVotes = rating.Votes.Value;
        }
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        shouldRender = true;
        return base.OnAfterRenderAsync(firstRender);
    }

    private static string ToYear(string date) => DateTime.TryParse(date, out var dateTime) ? dateTime.Year.ToString() : string.Empty;

    private async void RateMovie(int? id)
    {
        if (value == 0)
        {
            _notificationService.Notify(new NotificationMessage {Severity = NotificationSeverity.Warning, Summary = "No rating value selected", Duration = 4000});
        }
        else if (userId == null)
        {
            _notificationService.Notify(new NotificationMessage {Severity = NotificationSeverity.Warning, Summary = "Log in to rate", Duration = 4000});
        }
        else
        {
            loading = true;
            RatedMovieDto ratedMovie = new RatedMovieDto()
            {
                RatedMovieId = id,
                Rating = value,
                UserId = userId
            };

            await _movieService.AddRatingAsync(ratedMovie);

            CheckRatingInDb();
            await Task.Delay(1000);
            loading = false;
            _notificationService.Notify(new NotificationMessage {Severity = NotificationSeverity.Success, Summary = "Rating Saved", Duration = 4000});
            StateHasChanged();
        }
    }

    private void SetUserId(AuthenticationState context)
    {
        userId = context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    }

}